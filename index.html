<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Cabutan Bertuah - Sambutan Hari Keluarga FAMA</title>		
        <link href="demo.css" rel="stylesheet" />
        <style>
            .crappy-plastic-part-made-in-china {
                background-color: #222;
                height: 3em;
                font-size: 6em;
                overflow: hidden;
            }
            .pad {
                display: flex;
                width: 8.9em;
                margin: 0 auto;
                height: 1.8em;
            }
            ul {
                list-style: none;
                padding: 0;
                margin: -4.25em 0 0 0;
                width: 1.5em;
                height: 12em;
                float: center;
            }
            li {
                height: 2.2em;
                width: 0.9em;
                line-height: 2;
                background-color: #222;
                color: #fff;
                text-align: center;
                cursor: pointer;
                font-size: 2em;
                font-weight: bold;
                font-family: "Helvetica Neue", Arial, sans-serif;
            }
            li.roundabout-in-focus {
                cursor: default;
            }
            li span {
                display: block;
                padding-top: 0em;
            }

            #carbonads-container {
                clear: both;
                margin-top: 1em;
            }
            #carbonads-container .carbonad {
                margin: 0 auto;
            }
            /* Responsive table & button styles */
            #history-table {
                font-size: 1.1em;
                width: 95%;
                max-width: 500px;
                margin: 2em auto;
                text-align: center;
                border-collapse: collapse;
            }
            #history-table th, #history-table td {
                padding: 0.5em 0.7em;
                text-align: center;
            }
            #history-table th {
                background: #f2f2f2;
            }
            #history-table tr:nth-child(even) {
                background: #fafafa;
            }

            .interact {
                text-align: center;
                margin: 2em 0 1em 0;
            }
            .interact select,
            .interact a {
                font-size: 1.1em;
                padding: 0.5em 1.2em;
                margin: 0.3em 0.5em;
                border-radius: 0.5em;
                border: none;
                background: #2980b9;
                color: #fff;
                cursor: pointer;
                transition: background 0.2s;
                display: inline-block;
            }
            .interact select {
                background: #fff;
                color: #222;
                border: 1px solid #2980b9;
            }
            .interact a:hover,
            .interact select:focus {
                background: #3498db;
                color: #fff;
            }

            @media (max-width: 600px) {
                #history-table {
                    font-size: 0.95em;
                    width: 100%;
                    max-width: 100vw;
                }
                .interact select,
                .interact a {
                    font-size: 1em;
                    padding: 0.4em 0.7em;
                    margin: 0.2em 0.2em;
                }
            }
            h2 {
                text-align: center;
                font-size: 2em;
                margin-top: 2em;
                font-weight: bold;
            }

            .splash-effect {
                animation: splash 1.2s cubic-bezier(.36,2.01,.54,.98);
                box-shadow: 0 0 40px 10px gold, 0 0 80px 30px orange;
                background: #fff !important;
                color: #d35400 !important;
            }
            @keyframes splash {
                0%   { transform: scale(1); }
                20%  { transform: scale(1.25) rotate(-3deg);}
                40%  { transform: scale(0.95) rotate(2deg);}
                60%  { transform: scale(1.15) rotate(-1deg);}
                80%  { transform: scale(1.05);}
                100% { transform: scale(1); }
            }
            @keyframes shake {
                0% { transform: translateX(0); }
                20% { transform: translateX(-8px); }
                40% { transform: translateX(8px); }
                60% { transform: translateX(-6px); }
                80% { transform: translateX(6px); }
                100% { transform: translateX(0); }
            }
            .shake-effect {
                animation: shake 0.6s cubic-bezier(.36,2.01,.54,.98);
            }
            .rainbow-glow {
                text-shadow:
                    0 0 10px #fff,
                    0 0 20px #ff00de,
                    0 0 30px #ff00de,
                    0 0 40px #00c3ff,
                    0 0 70px #00c3ff,
                    0 0 80px #00c3ff,
                    0 0 100px #00c3ff;
                transition: text-shadow 0.2s;
            }
            /* Hujan hadiah & duit */
            .gift-rain, .money-rain {
                position: fixed;
                top: 0; left: 0; width: 100vw; height: 100vh;
                pointer-events: none;
                z-index: 9998;
            }
            /* Besarkan emoji hujan hadiah & duit */
            .gift, .money {
                position: absolute;
                font-size: 3em; /* asal 2.2em, kini lebih besar */
                will-change: transform;
                animation: fall-gift 2.5s linear forwards;
            }
            @keyframes fall-gift {
                0% { transform: translateY(-10vh) rotate(-20deg) scale(1); opacity: 1;}
                80% { opacity: 1;}
                100% { transform: translateY(100vh) rotate(30deg) scale(1.2); opacity: 0.7;}
            }

            .history-tables {
                display: flex;
                flex-wrap: nowrap;
                justify-content: center;
                gap: 1vw;
                overflow-x: visible; /* Tiada scroll */
                margin: 2em 0;
            }
            .history-table {
                flex: 0 0 auto;
                width: 170px;           /* Lebar lebih kecil */
                min-width: 120px;
                font-size: 0.95em;      /* Font lebih kecil */
                margin-bottom: 0.5em;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.06);
                border-collapse: collapse;
            }
            .history-table th, .history-table td {
                padding: 0.3em 0.3em;
                font-size: 0.95em;
                word-break: break-word;
            }
            @media (max-width: 900px) {
                .history-table {
                    width: 22vw;
                    min-width: 90px;
                    max-width: 140px;
                    font-size: 0.85em;
                }
                .history-table th, .history-table td {
                    font-size: 0.85em;
                    padding: 0.2em 0.1em;
                }
            }
        </style>
    </head>
<body>
<h1>Nombor Bertuah</h1>
    <div class="crappy-plastic-part-made-in-china">
        <div class="pad">
            <ul><li></li></ul>
            <ul id="digit-3">
                <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li>
            </ul>
            <ul id="digit-2">
                <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li>
            </ul>
            <ul id="digit-1">
                <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li>
            </ul>
            <ul id="digit-0">
                <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li>
            </ul>
            <ul><li></li></ul>
        </div>
    </div>
    <div class="interact">
        <select id="draw-count">
            <option value="1">1 Cabutan</option>
            <option value="10">10 Cabutan Serentak</option>
            <option value="20">20 Cabutan Serentak</option>
        </select>
        <a href="#" id="contribute">Cabutan</a>
        <a href='#' onclick='location.reload(true); return false;'>Set Semula</a>
        <a href="#" id="download-log">Muat Turun</a>
    </div>

    <!-- Paparan jumlah cabutan -->
    <div id="statistik-cabutan" style="text-align:center; font-size:1.2em; margin-bottom:1em;">
        Sudah keluar: <span id="total-keluar">0</span> &nbsp; | &nbsp; Masih belum keluar: <span id="total-belum">1300</span>
    </div>

    <!-- Table untuk paparan nombor yang sudah keluar -->
    <h2>Senarai Nombor Yang Sudah Keluar</h2>
    <div class="history-tables">
        <table id="history-table-1" class="history-table" border="1">
            <thead>
                <tr><th>Bil</th><th>Nombor</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="2" style="color:#888;">Belum ada cabutan</td></tr>
            </tbody>
        </table>
        <table id="history-table-2" class="history-table" border="1">
            <thead>
                <tr><th>Bil</th><th>Nombor</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="2" style="color:#888;">Belum ada cabutan</td></tr>
            </tbody>
        </table>
        <table id="history-table-3" class="history-table" border="1">
            <thead>
                <tr><th>Bil</th><th>Nombor</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="2" style="color:#888;">Belum ada cabutan</td></tr>
            </tbody>
        </table>
        <table id="history-table-4" class="history-table" border="1">
            <thead>
                <tr><th>Bil</th><th>Nombor</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="2" style="color:#888;">Belum ada cabutan</td></tr>
            </tbody>
        </table>
        <table id="history-table-5" class="history-table" border="1">
            <thead>
                <tr><th>Bil</th><th>Nombor</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="2" style="color:#888;">Belum ada cabutan</td></tr>
            </tbody>
        </table>
        <table id="history-table-6" class="history-table" border="1">
            <thead>
                <tr><th>Bil</th><th>Nombor</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="2" style="color:#888;">Belum ada cabutan</td></tr>
            </tbody>
        </table>
    </div>
    <!-- Tambah butang di bawah table sejarah -->
    <canvas id="fireworks-canvas" style="position:fixed;pointer-events:none;top:0;left:0;width:100vw;height:100vh;z-index:9999;"></canvas>
    <div class="gift-rain"></div>
    <div class="money-rain"></div>
    <!--<audio id="cheer-audio" src="efek.mp3" preload="auto"></audio> -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="jquery.roundabout2.js"></script>
    <script src="jquery.roundabout-shapes2.js"></script>
    <script src="jquery.easing.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
// Total nombor
var TOTAL_NUMBER = 1300;

// Simpan timestamp setiap cabutan
var historyTimestamps = [];

function showFireworks() {
    // Bunga api tengah
    confetti({
        particleCount: 600,
        spread: 180,
        startVelocity: 120,
        scalar: 1.4,
        origin: { y: 0.6 }
    });

    // Bunga api dari bucu kiri bawah
    confetti({
        particleCount: 120,
        angle: 60,
        spread: 80,
        startVelocity: 90,
        scalar: 1.2,
        origin: { x: 0, y: 1 }
    });

    // Bunga api dari bucu kanan bawah
    confetti({
        particleCount: 120,
        angle: 120,
        spread: 80,
        startVelocity: 90,
        scalar: 1.2,
        origin: { x: 1, y: 1 }
    });

    // Tambah confetti bentuk bintang
    confetti({
        particleCount: 80,
        spread: 100,
        startVelocity: 60,
        scalar: 2,
        shapes: ['star'],
        origin: { x: 0.5, y: 0.2 }
    });

    // Mainkan bunyi sorakan selepas bunga api keluar
    setTimeout(function() {
        var audio = document.getElementById('cheer-audio');
        if (audio) {
            audio.currentTime = 0;
            audio.play();
        }
    }, 400); // mainkan selepas 0.4 saat bunga api
}

// Fungsi untuk hujan hadiah
function rainGift(count = 30) {
  const gifts = ['ğŸ','ğŸ›ï¸','ğŸ‰','ğŸŠ','ğŸˆ','ğŸ‚','ğŸ¬','ğŸ­','ğŸ›µ','ğŸï¸','ğŸ›µğŸ’¨ğŸâœ¨','ğŸ±ğŸ¥¢ğŸ°','ğŸ°ğŸª„ğŸ«§ğŸ”®'];
  const container = document.querySelector('.gift-rain');
  for (let i = 0; i < count; i++) {
    const el = document.createElement('span');
    el.className = 'gift';
    el.innerText = gifts[Math.floor(Math.random() * gifts.length)];
    el.style.left = Math.random() * 97 + 'vw';
    el.style.animationDuration = (2.5 + Math.random() * 2.5) + 's';
    el.style.fontSize = (2.5 + Math.random() * 2.5) + 'em'; // asal 1.2~3.4em, kini 2.5~5em
    container.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }
}

function rainMoney(count = 40) {
  const moneys = ['ğŸ’°','ğŸª™','ğŸ’µ','ğŸ’¸','ğŸ¤‘','ğŸ’²','ğŸ’·','ğŸ’¶','ğŸ›º','ğŸ’–','ğŸŒ¸ğŸ€ğŸ¦©ğŸ’•ğŸŒ·','ğŸŒ•ğŸŒ—ğŸŒ‘ğŸŒ“ğŸŒ•'];
  const container = document.querySelector('.money-rain');
  for (let i = 0; i < count; i++) {
    const el = document.createElement('span');
    el.className = 'money';
    el.innerText = moneys[Math.floor(Math.random() * moneys.length)];
    el.style.left = Math.random() * 97 + 'vw';
    el.style.animationDuration = (2.2 + Math.random() * 2.8) + 's';
    el.style.fontSize = (2.2 + Math.random() * 2.8) + 'em'; // asal 1.1~3.4em, kini 2.2~5em
    container.appendChild(el);
    setTimeout(() => el.remove(), 4200);
  }
}

var count = 0,
    clickable = true,
    historyNumbers = []; // Array untuk simpan nombor yang sudah keluar

// Kira jumlah nombor yang sudah dan belum keluar
function updateCabutanStats() {
    var totalKeluar = historyNumbers.length;
    var totalBelum = TOTAL_NUMBER - totalKeluar;
    $('#total-keluar').text(totalKeluar);
    $('#total-belum').text(totalBelum);
}

$(document).ready(function() {
    // Pastikan roundabout hanya pada digit
    $('ul[id^="digit-"]').roundabout({
        shape: "waterWheel",
        duration: 1200 // dalam milisaat (1200ms = 1.2 saat)
    });

    $('#contribute').click(function() {
        if (!clickable) return false;
        $('.interact a').fadeTo(100, 0.5);
        clickable = false;

        var drawCount = parseInt($('#draw-count').val(), 10);
        var cabutanBaru = [];
        var maxTry = 5000, tryCount = 0;

        if (historyNumbers.length >= TOTAL_NUMBER) {
            alert("Semua nombor telah dicabut!");
            $('.interact a').fadeTo(100, 1);
            clickable = false;
            return false;
        }

        while (cabutanBaru.length < drawCount && tryCount < maxTry) {
            var excludeArr = historyNumbers.concat(cabutanBaru);
            var num = getBalancedRandomNumber(excludeArr);
            if (excludeArr.indexOf(num) === -1) {
                cabutanBaru.push(num);
            }
            tryCount++;
            if (historyNumbers.length + cabutanBaru.length >= TOTAL_NUMBER) break;
        }

        if (cabutanBaru.length === 0) {
            alert("Tiada nombor baru boleh dicabut.");
            $('.interact a').fadeTo(100, 1);
            clickable = false;
            return false;
        }

        // Papar queue cabutan satu persatu
        function animateQueue(idx) {
            if (idx >= cabutanBaru.length) {
                // Semua selesai, update history dan enable button
                historyNumbers = historyNumbers.concat(cabutanBaru);
                updateHistoryTable();
                updateCabutanStats();
                $('.interact a').fadeTo(100, 1);
                clickable = true;
                return;
            }
            applyCount(cabutanBaru[idx]);
            showFireworks();

            // Simpan timestamp untuk setiap cabutan
            historyTimestamps.push(new Date().toLocaleString());

            // Tunggu animasi digit selesai sebelum bacaan suara
            setTimeout(function() {
                speakNumber(cabutanBaru[idx]);

                // Tunggu suara habis sebelum ke nombor seterusnya
                let msg = new SpeechSynthesisUtterance(cabutanBaru[idx].toString().split('').join(' '));
                msg.lang = 'ms-MY';
                msg.rate = 0.75;
                let voices = window.speechSynthesis.getVoices();
                let bmVoice = voices.find(v => v.lang === 'ms-MY');
                if (bmVoice) msg.voice = bmVoice;

                msg.onend = function() {
                    updateHistoryTable(historyNumbers.concat(cabutanBaru.slice(0, idx + 1)));
                    animateQueue(idx + 1);
                };
                window.speechSynthesis.speak(msg);
            }, 1200); // 1200ms = tempoh animasi digit
        }

        // Kosongkan highlight table, mula queue
        updateHistoryTable(historyNumbers);
        animateQueue(0);

        return false;
    });

    $('#how-much').click(function() {
        alert('The counter is currently at ' + count + '.');
        return false;
    });
});

// Fungsi untuk kemas kini jadual sejarah (4 digit)
function updateHistoryTable(arr) {
    var data = arr || historyNumbers;
    var perTable = 10;
    var totalTable = Math.ceil(data.length / perTable);

    // Buang semua table sejarah lama
    $('.history-tables').empty();

    // Bina table-table baru ikut keperluan
    for (let t = 0; t < totalTable; t++) {
        // Cipta table baru
        let table = $('<table/>', {
            id: 'history-table-' + (t + 1),
            class: 'history-table',
            border: 1
        });
        let thead = $('<thead><tr><th>Bil</th><th>Nombor</th></tr></thead>');
        let tbody = $('<tbody></tbody>');
        table.append(thead).append(tbody);

        let start = t * perTable;
        let end = Math.min((t + 1) * perTable, data.length);
        let sub = data.slice(start, end);

        if (sub.length === 0) {
            tbody.append('<tr><td colspan="2" style="color:#888;">Belum ada cabutan</td></tr>');
        } else {
            for (let i = 0; i < sub.length; i++) {
                let num = sub[i].toString();
                tbody.append('<tr><td>' + (start + i + 1) + '</td><td>' + num + '</td></tr>');
            }
        }
        $('.history-tables').append(table);
    }

    var totalKeluar = data.length;
    var totalBelum = TOTAL_NUMBER - totalKeluar;
    $('#total-keluar').text(totalKeluar);
    $('#total-belum').text(totalBelum);
}

// Fungsi untuk animasi digit (4 digit) + efek meriah
function applyCount(total) {
    var str = total.toString().padStart(4, '0');
    for (var i = 0; i < 4; i++) {
        var part = parseInt(str[i], 10);
        var $ul = $('#digit-' + (3 - i));
        if ($ul.length && $ul.data('roundabout')) {
            var child = $ul.data('roundabout').childInFocus;
            var factor = (part < child) ? (10 + part) - child : part - child;
            var distance = factor * 36;
            if (i < 3) {
                $ul.roundabout('animateToDelta', -distance);
            } else {
                $ul.roundabout('animateToDelta', -distance, { duration: 1200 }, function() {
                    $('.interact a').fadeTo(100, 1);
                    clickable = true;
                });
            }
        }
        // Gabung efek splash, shake, dan glow
        var $li = $ul.find('li').eq(part);
        $li.addClass('splash-effect shake-effect rainbow-glow');
        setTimeout(function(li){
            li.removeClass('splash-effect shake-effect rainbow-glow');
        }.bind(null, $li), 1200);
    }
    // Tambah efek hujan hadiah & duit
    rainGift();
    rainMoney();
}

function getBalancedRandomNumber(excludeArr) {
    // 25% peluang setiap kategori digit
    var rand = Math.random();
    var kategori;
    if (rand < 0.25) {
        kategori = 0; // 1 digit (3001-3009)
    } else if (rand < 0.50) {
        kategori = 1; // 2 digit (3010-3099)
    } else if (rand < 0.75) {
        kategori = 2; // 3 digit (3100-3999)
    } else {
        kategori = 3; // 4 digit (4000-4300)
    }

    var num, maxTry = 100, tryCount = 0;
    do {
        if (kategori === 0) {
            num = 3001 + Math.floor(Math.random() * 9); // 3001-3009
        } else if (kategori === 1) {
            num = 3010 + Math.floor(Math.random() * 90); // 3010-3099
        } else if (kategori === 2) {
            num = 3100 + Math.floor(Math.random() * 900); // 3100-3999
        } else {
            num = 4000 + Math.floor(Math.random() * 301); // 4000-4300
        }
        tryCount++;
    } while (
        excludeArr.indexOf(num) !== -1 && tryCount < maxTry
    );
    return num;
}

// Fungsi untuk export log ke CSV (boleh dibuka dengan Excel)
function downloadLogExcel() {
    let csv = 'Bil,Nombor,Timestamp\n';
    for (let i = 0; i < historyNumbers.length; i++) {
        let num = historyNumbers[i].toString();
        let ts = historyTimestamps[i] || '';
        csv += (i + 1) + ',' + num + ',' + ts + '\n';
    }
    // Buat fail dan trigger download
    let blob = new Blob([csv], { type: 'text/csv' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'log-cabutan.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Trigger bila klik butang
$('#download-log').click(function(e) {
    e.preventDefault();
    downloadLogExcel();
});

function speakNumber(num) {
    let str = num.toString();
    let digits = str.split('').join(' ');
    let msg = new SpeechSynthesisUtterance(digits);
    msg.lang = 'ms-MY';
    msg.rate = 0.75;

    // Fungsi untuk pilih suara ms-MY jika ada
    function setVoiceAndSpeak() {
        let voices = window.speechSynthesis.getVoices();
        let bmVoice = voices.find(v => v.lang === 'ms-MY');
        if (bmVoice) {
            msg.voice = bmVoice;
        }
        window.speechSynthesis.speak(msg);
    }

    // Jika voices belum dimuat, tunggu event
    if (window.speechSynthesis.getVoices().length === 0) {
        window.speechSynthesis.onvoiceschanged = setVoiceAndSpeak;
    } else {
        setVoiceAndSpeak();
    }
}
console.log(window.speechSynthesis.getVoices());
    </script>
</body>
</html>